###Test for and Install Packages

if (!require("shiny")) install.packages("shiny",dependencies=TRUE); library("shiny")
if (!require("DT")) install.packages("DT",dependencies = TRUE); library("DT")

### Shiny App
ui = fluidPage(
    titlePanel("C4 Model"),
    sidebarPanel(width = 3,
                 paste("Inputs"),
                 textInput("linc_in","linc",value = 1800),
                 textInput("CM_in","CM",value = 500),
                 textInput("OM_in","OM",value = 210000),
                 textInput("gBS_in","gBS",value = 0.0015),
                 textInput("gamma_in","Y*",value = 0.0002),
                 textInput("RLIGHT_in","RLIGHT",value = 0.8),
                 textInput("ABBSM_in","AB BS/M",value=1.6),
                 textInput("YIILL_in","Y(2)LL",value = 0.7),
                 textInput("s_in","s",value = 0.4),
                 textInput("fPSEUDONRM_in","fPSEUDO NR M",value = 0.01),
                 textInput("fPSEUDONRBS_in","fPSEUDO NR BS",value = 0.01),
                 textInput("fQ_in","fQ",value = 1),
                 textInput("h_in","h",value = 4.67),
                 textInput("YILL_in","Y(1)LL",value = 1),
                 textInput("fNDHM_in","fNDH M",value = 0.3),
                 textInput("fNDHBS_in","fNDHBS",value = 0.6),
                 textInput("fCycM_in","fCyc M",value = 0.0001),
                 textInput("fCycBS_in","fCyc BS",value = 0.7),
                 textInput("alphaC_in","AlphaC",value = 0.02101),
                 textInput("V0C_in","V0C",value = 0),
                 textInput("thetaC_in","ThetaC",value = 0.87),
                 textInput("alphaV_in","AlphaV",value = 0.0014),
                 textInput("V0V_in","V0V",value = 0),
                 textInput("thetaV_in","ThetaV",value = 0.68),
                 textInput("fPH_in","fPH",value = 0.64),
                 textInput("fPEPCK_in","fPEPCK",value = 0.85),
                 textInput("fRLIGHT_in","fRLIGHT",value = 0.5),
                 textInput("fCS_in","fCS",value = 0.5),
                 textInput("fMDHM_in","f MDH  M",value = 1)
    ),
    mainPanel(
        tabsetPanel(
            tabPanel("Light Reactions",DT::dataTableOutput("LightReactions")),
            tabPanel("Overall Rates",DT::dataTableOutput("OverallRates")),
            tabPanel("CCM",DT::dataTableOutput("CCM")),
            tabPanel("BS/M Partitioning",DT::dataTableOutput("BSMPartitioning")),
            tabPanel("Reducing Power Balance",DT::dataTableOutput("ReducingPowerBalance")),
            tabPanel("Ratios",DT::dataTableOutput("Ratios")),
            tabPanel("Fluxes",DT::dataTableOutput("Fluxes"))
        )

             )
)

server = shinyServer(function(input, output) {
    
    paste("Light Reactions")
    
    input_data <- data.frame(Parameter = c("linc", "CM","OM","gBS","Y*","RLIGHT","AB BS/M","Y(2)LL","s","fPSEUDO NR M","fPSEUDO NR BS","fQ","h","Y(1)LL","fNDH M","fNDHBS","fCyc M","fCyc BS","??C","V0C","??C","??V","V0V","??V","fPH","fPEPCK","fRLIGHT","fCS","f MDH  M"),
                             Value = c (1800,500,210000,0.0015,0.0002,0.8,1.6,0.7,0.4,0.01,0.01,1,4.67,1,0.3,0.6,0.0001,0.7,0.02101,0,0.87,0.0014,0,0.68,0.64,0.85,0.5,0.5,1),
                             stringsAsFactors = FALSE)

    
    runModel = reactive(input$runModel)
    
    updateOutputs <- reactive({
        #Determine Input Values
        B4 = as.numeric(input$linc_in)
        B5 = as.numeric(input$CM_in)
        B6 = as.numeric(input$OM_in)
        B7 = as.numeric(input$gBS_in)
        B8 = as.numeric(input$gamma_in)
        B9 = as.numeric(input$RLIGHT_in)
        B10 = as.numeric(input$ABBSM_in)
        B11 = as.numeric(input$YIILL_in)
        B12 = as.numeric(input$s_in)
        B13 = as.numeric(input$fPSEUDONRM_in)
        B14 = as.numeric(input$fPSEUDONRBS_in)
        B15 = as.numeric(input$fQ_in)
        B16 = as.numeric(input$h_in)
        B17 = as.numeric(input$YILL_in)
        B18 = as.numeric(input$fNDHM_in)
        B19 = as.numeric(input$fNDHBS_in)
        B20 = as.numeric(input$fCycM_in)
        B21 = as.numeric(input$fCycBS_in)
        B22 = as.numeric(input$alphaC_in)
        B23 = as.numeric(input$V0C_in)
        B24 = as.numeric(input$thetaC_in)
        B25 = as.numeric(input$alphaV_in)
        B26 = as.numeric(input$V0V_in)
        B27 = as.numeric(input$thetaV_in)
        B28 = as.numeric(input$fPH_in)
        B29 = as.numeric(input$fPEPCK_in)
        B30 = as.numeric(input$fRLIGHT_in)
        B31 = as.numeric(input$fCS_in)
        B32 = as.numeric(input$fMDHM_in)

        #Mesophyll Light Reactions Calculations
        G6 = B4/(1+B10)
        G7 = B11*B12
        G8 = 1-max(0,(B25*G6+1-B26)/(2*B27)-sqrt((B25*G6+1-B26)^2-4*B25*G6*B27*(1-B26))/(2*B27)+B26)
        G9 = max(0,(B22*B5+1-B23)/(2*B24)-sqrt((B22*B5+1-B23)^2-4*B22*B5*B24*(1-B23))/(2*B24)+B23)
        G10 = G8*B11*G9
        G11 = G6*B12
        G12 = G11*B11
        G13 = G12/B17
        G14 = B20/(1-B20+B11)
        G15 = (1/B11-G14)*G12
        G16 = (1+G14)*G13
        G17 = G15+G16
        G18 = G15*G10
        G19 = G18/(1-B20)
        G20 = G18/B16+2*B15*G18/(B16*(1-B20))+2*B18*B20*G18/(B16*(1-B20))+(1-B15)*G18/(B16*(1-B20))
        G22 = 0.0000004*B6+B13
        G21 = (1-B20-G22)*G18/(2*(1-B20))
        
        #Bundle Sheath Light Reactions Calculations
        H6 = G6*B10
        H7 = B11*B12
        H8 = 1-max(0,(B25*H6+1-B26)/(2*B27)-sqrt((B25*H6+1-B26)^2-4*B25*H6*B27*(1-B26))/(2*B27)+B26)
        H9 = max(0,(B22*B5+1-B23)/(2*B24)-sqrt((B22*B5+1-B23)^2-4*B22*B5*B24*(1-B23))/(2*B24)+B23)
        H10 = H8*B11*H9
        H11 = H6*B12
        H12 = H11*B11
        H13 = H12/B17
        H14 = B21/(1-B21+B11)
        H15 = (1/B11-H14)*H12
        H16 = (1+H14)*H13
        H17 = H15+H16
        H18 = H15*H10
        H19 = H18/(1-B21)
        H20 = H18/B16+2*B15*H18/(B16*(1-B21))+2*B19*B21*H18/(B16*(1-B21))+(1-B15)*H18/(B16*(1-B21))
        H22 = 0.0000004*B6+B14
        H21 = (1-B21-H22)*H18/(2*(1-B21))
        
        #Create Light Reactions Data Frame
        LightReactions = data.frame(Parameter = c("Iinc","Y(J)LL","f(PPFD)","f(CM)","Y(2)","I2 0","J2 0","I1 0","x","I2","I1","Itot","J2","J1","JATP","JNADPH","fpseudo wwc"),
                                    M = c (G6,G7,G8,G9,G10,G11,G12,G13,G14,G15,G16,G17,G18,G19,G20,G21,G22),
                                    BS = c (H6,H7,H8,H9,H10,H11,H12,H13,H14,H15,H16,H17,H18,H19,H20,H21,H22),
                                    stringsAsFactors = FALSE)
        
        #CBS Pre-Calculations
        K16 = G21+H21
        P9 = B9*B30
        O15 = B5
        P16 = B6+1/4*H18/(0.047*B7)
        
        #V20
        V20.1 = 5184*B29*H20^2-21204*K16^2*B29-52*B9^2*B29-5184*G20^2*B29-20736*B29*P9^2+5184*G20^2+34596*K16^2+676*B9^2+5184*H20^2+1296*G20^2*B29^2-3447*K16^2*B29^2+2052*K16^2*B29^3+324*K16^2*B29^4-311*B9^2*B29^2+12*B9^2*B29^3+36*B9^2*B29^4+20736*P9^2+20736*B7^2*O15^2-3888*B29^2*H20^2-2592*B29^3*H20^2+1296*B29^4*H20^2+5184*B29^2*H21^2-5184*B29^3*H21^2+1296*B29^4*H21^2+5184*B29^2*P9^2-26784*G20*K16-3744*G20*B9+9672*K16*B9+10368*G20*H20-26784*K16*H20-3744*B9*H20+20736*G20*P9-53568*K16*P9-7488*B9*P9+20736*H20*P9+2592*G20^2*B29^2*B32+13194*K16^2*B29^2*B32-648*K16^2*B29^4*B32+314*B9^2*B29^2*B32-72*B9^2*B29^4*B32+21600*K16^2*B29^2*B28-1512*K16^2*B29^3*B28-1296*K16^2*B29^4*B28+672*B9^2*B29^2*B28+264*B9^2*B29^3*B28-144*B9^2*B29^4*B28+2592*B29^2*H20^2*B32+5184*B29^3*H20^2*B32-2592*B29^4*H20^2*B32-5184*B29^3*H21^2*B32+2592*B29^4*H21^2*B32+15552*B29^3*H20^2*B28-5184*B29^4*H20^2*B28-20736*B29^2*H21^2*B28+20736*B29^3*H21^2*B28-5184*B29^4*H21^2*B28+21600*G20*K16*B29+2016*G20*B9*B29+20736*B7*G20*O15-3336*K16*B9*B29-53568*B7*K16*O15-7488*B7*B9*O15-10368*G20*B29*H21-5184*K16*B29*H20-1728*B9*B29*H20+26784*K16*B29*H21+20736*B7*H20*O15-20736*G20*B29*P9+3744*B9*B29*H21+43200*K16*B29*P9+4032*B9*B29*P9+41472*B7*P9*O15-10368*B29*H20*H21-20736*B29*H21*P9+36*B31^2*K16^2*B29^2-36*B31^2*K16^2*B29^3+9*B31^2*K16^2*B29^4+100*B31^2*B9^2*B29^2-100*B31^2*B9^2*B29^3+25*B31^2*B9^2*B29^4+5184*B7^2*B29^2*O15^2+1296*G20^2*B29^2*B32^2+3249*K16^2*B29^2*B32^2-2052*K16^2*B29^3*B32^2+324*K16^2*B29^4*B32^2+B9^2*B29^2*B32^2-12*B9^2*B29^3*B32^2+36*B9^2*B29^4*B32^2+82944*B7^2*P16^2*B8^2+5184*K16^2*B29^2*B28^2-5184*K16^2*B29^3*B28^2+1296*K16^2*B29^4*B28^2+576*B9^2*B29^2*B28^2-576*B9^2*B29^3*B28^2+144*B9^2*B29^4*B28^2+1296*B29^2*H20^2*B32^2-2592*B29^3*H20^2*B32^2+1296*B29^4*H20^2*B32^2+1296*B29^4*H21^2*B32^2+20736*B29^2*H20^2*B28^2-20736*B29^3*H20^2*B28^2+5184*B29^4*H20^2*B28^2+20736*B29^2*H21^2*B28^2-20736*B29^3*H21^2*B28^2+5184*B29^4*H21^2*B28^2-1512*G20*K16*B29^2-1296*G20*K16*B29^3+792*G20*B9*B29^2-432*G20*B9*B29^3+2232*B31*K16^2*B29-520*B31*B9^2*B29-3054*K16*B9*B29^2+720*K16*B9*B29^3+216*K16*B9*B29^4-7776*G20*B29^2*H20+2592*G20*B29^3*H20+10368*G20*B29^2*H21-2592*G20*B29^3*H21+20088*K16*B29^2*H20-2808*K16*B29^3*H20-1296*K16*B29^4*H20+2808*B9*B29^2*H20+360*B9*B29^3*H20-432*B9*B29^4*H20-21600*K16*B29^2*H21+1512*K16*B29^3*H21+1296*K16*B29^4*H21+5184*G20*B29^2*P9-2016*B9*B29^2*H21-792*B9*B29^3*H21+432*B9*B29^4*H21-3024*K16*B29^2*P9-2592*K16*B29^3*P9+1584*B9*B29^2*P9-864*B9*B29^3*P9-5184*G20^2*B29*B32-21204*K16^2*B29*B32-52*B9^2*B29*B32+7776*B29^3*H20*H21-2592*B29^4*H20*H21-15552*B29^2*H20*P9+5184*B29^3*H20*P9+20736*B29^2*H21*P9-5184*B29^3*H21*P9-26784*K16^2*B29*B28-1248*B9^2*B29*B28-5184*B29*H20^2*B32-20736*B29*H20^2*B28-1800*B31*K16^2*B29^2+126*B31*K16^2*B29^3+108*B31*K16^2*B29^4+280*B31*B9^2*B29^2+110*B31*B9^2*B29^3-60*B31*B9^2*B29^4-20736*B7^2*B29*O15^2+41472*B29^2*H20*P9*B28-10368*B29^3*H20*P9*B28-41472*B29^2*H21*P9*B28+10368*B29^3*H21*P9*B28+10368*B29*H20^2*B32*B28+9*B31^2*K16^2*B29^2*B32^2+36*B31^2*K16^2*B29^3*B32^2+36*B31^2*K16^2*B29^4*B32^2+25*B31^2*B9^2*B29^2*B32^2+100*B31^2*B9^2*B29^3*B32^2+100*B31^2*B9^2*B29^4*B32^2+144*B31^2*K16^2*B29^2*B28^2-144*B31^2*K16^2*B29^3*B28^2+36*B31^2*K16^2*B29^4*B28^2+400*B31^2*B9^2*B29^2*B28^2-400*B31^2*B9^2*B29^3*B28^2+100*B31^2*B9^2*B29^4*B28^2+20736*B7^2*B29^2*P16^2*B8^2+5184*G20^2*B29^2*B32^2*B28^2+12996*K16^2*B29^2*B32^2*B28^2-8208*K16^2*B29^3*B32^2*B28^2+1296*K16^2*B29^4*B32^2*B28^2
        V20.2 = 4*B9^2*B29^2*B32^2*B28^2-48*B9^2*B29^3*B32^2*B28^2+144*B9^2*B29^4*B32^2*B28^2+5184*B29^2*H20^2*B32^2*B28^2-10368*B29^3*H20^2*B32^2*B28^2+5184*B29^4*H20^2*B32^2*B28^2+5184*B29^4*H21^2*B32^2*B28^2-120*B31^2*K16*B9*B29^2+120*B31^2*K16*B9*B29^3-30*B31^2*K16*B9*B29^4-4104*G20*K16*B29^2*B32^2+1296*G20*K16*B29^3*B32^2-72*G20*B9*B29^2*B32^2+432*G20*B9*B29^3*B32^2+1206*B31*K16^2*B29^2*B32-234*B31*K16^2*B29^3*B32-324*B31*K16^2*B29^4*B32-490*B31*B9^2*B29^2*B32-50*B31*B9^2*B29^3*B32+180*B31*B9^2*B29^4*B32+114*K16*B9*B29^2*B32^2-720*K16*B9*B29^3*B32^2+216*K16*B9*B29^4*B32^2+2736*B31*K16^2*B29^2*B28+612*B31*K16^2*B29^3*B28-432*B31*K16^2*B29^4*B28-80*B31*B9^2*B29^2*B28-700*B31*B9^2*B29^3*B28+240*B31*B9^2*B29^4*B28+2592*G20*B29^2*H20*B32^2-2592*G20*B29^3*H20*B32^2+3456*K16*B9*B29^2*B28^2-3456*K16*B9*B29^3*B28^2+864*K16*B9*B29^4*B28^2-2592*G20*B29^3*H21*B32^2-4104*K16*B29^2*H20*B32^2+5400*K16*B29^3*H20*B32^2-1296*K16*B29^4*H20*B32^2-72*B9*B29^2*H20*B32^2+504*B9*B29^3*H20*B32^2-432*B9*B29^4*H20*B32^2+4104*K16*B29^3*H21*B32^2-1296*K16*B29^4*H21*B32^2+72*B9*B29^3*H21*B32^2-432*B9*B29^4*H21*B32^2-20736*K16*B29^2*H20*B28^2+20736*K16*B29^3*H20*B28^2-5184*K16*B29^4*H20*B28^2-6912*B9*B29^2*H20*B28^2+6912*B9*B29^3*H20*B28^2-1728*B9*B29^4*H20*B28^2+20736*K16*B29^2*H21*B28^2-20736*K16*B29^3*H21*B28^2+5184*K16*B29^4*H21*B28^2+6912*B9*B29^2*H21*B28^2-6912*B9*B29^3*H21*B28^2+1728*B9*B29^4*H21*B28^2-2592*B29^3*H20*H21*B32^2+2592*B29^4*H20*H21*B32^2-5184*G20^2*B29^2*B32*B28-18180*K16^2*B29^2*B32*B28-6696*K16^2*B29^3*B32*B28+2592*K16^2*B29^4*B32*B28-580*B9^2*B29^2*B32*B28-41472*B29^2*H20*H21*B28^2-312*B9^2*B29^3*B32*B28+41472*B29^3*H20*H21*B28^2+288*B9^2*B29^4*B32*B28-10368*B29^4*H20*H21*B28^2+5184*B29^2*H20^2*B32*B28-25920*B29^3*H20^2*B32*B28+10368*B29^4*H20^2*B32*B28+20736*B29^3*H21^2*B32*B28-10368*B29^4*H21^2*B32*B28-864*G20*B31*K16*B29+1440*G20*B31*B9*B29-3408*B31*K16*B9*B29-20736*B7*G20*B29*O15-864*B31*K16*B29*H20+1440*B31*B9*B29*H20+43200*B7*K16*B29*O15+4032*B7*B9*B29*O15-1728*B31*K16*B29*P9+2880*B31*B9*B29*P9+21600*G20*K16*B29*B32+2016*G20*B9*B29*B32-3336*K16*B9*B29*B32+41472*B7*G20*P16*B8-20736*B7*B29*H21*O15+10368*G20*K16*B29*B28+3456*G20*B9*B29*B28+6912*B7*K16*P16*B8+23040*B7*B9*P16*B8-41472*B7*B29*P9*O15-10368*G20*B29*H20*B32-12672*K16*B9*B29*B28+21600*K16*B29*H20*B32+2016*B9*B29*H20*B32-10368*G20*B29*P9*B32-20736*G20*B29*H20*B28+41472*B7*H20*P16*B8+20736*G20*B29*H21*B28+16416*K16*B29*P9*B32+288*B9*B29*P9*B32+63936*K16*B29*H20*B28+10944*B9*B29*H20*B28-53568*K16*B29*H21*B28-7488*B9*B29*H21*B28+82944*B7*P9*P16*B8+20736*K16*B29*P9*B28+6912*B9*B29*P9*B28-10368*B29*H20*P9*B32+20736*B29*H20*H21*B28-41472*B29*H20*P9*B28+41472*B29*H21*P9*B28-342*B31*K16^2*B29^2*B32^2+36*B31^2*K16^2*B29^2*B32-576*B31*K16^2*B29^3*B32^2+54*B31^2*K16^2*B29^3*B32+216*B31*K16^2*B29^4*B32^2-36*B31^2*K16^2*B29^4*B32+10*B31*B9^2*B29^2*B32^2+100*B31^2*B9^2*B29^2*B32-40*B31*B9^2*B29^3*B32^2+150*B31^2*B9^2*B29^3*B32-120*B31*B9^2*B29^4*B32^2-100*B31^2*B9^2*B29^4*B32+1728*B31*K16^2*B29^2*B28^2-144*B31^2*K16^2*B29^2*B28-1728*B31*K16^2*B29^3*B28^2+144*B31^2*K16^2*B29^3*B28+432*B31*K16^2*B29^4*B28^2-36*B31^2*K16^2*B29^4*B28-960*B31*B9^2*B29^2*B28^2-400*B31^2*B9^2*B29^2*B28+960*B31*B9^2*B29^3*B28^2+400*B31^2*B9^2*B29^3*B28-240*B31*B9^2*B29^4*B28^2-100*B31^2*B9^2*B29^4*B28-82944*B7^2*B29*P16^2*B8^2-5184*G20^2*B29^2*B32^2*B28-16416*K16^2*B29^2*B32*B28^2-12996*K16^2*B29^2*B32^2*B28+13392*K16^2*B29^3*B32*B28^2
        V20.3 = 8208*K16^2*B29^3*B32^2*B28-2592*K16^2*B29^4*B32*B28^2-1296*K16^2*B29^4*B32^2*B28-96*B9^2*B29^2*B32*B28^2-4*B9^2*B29^2*B32^2*B28+624*B9^2*B29^3*B32*B28^2+48*B9^2*B29^3*B32^2*B28-288*B9^2*B29^4*B32*B28^2-144*B9^2*B29^4*B32^2*B28-20736*B29^2*H20^2*B32*B28^2-5184*B29^2*H20^2*B32^2*B28+31104*B29^3*H20^2*B32*B28^2+10368*B29^3*H20^2*B32^2*B28-10368*B29^4*H20^2*B32*B28^2-5184*B29^4*H20^2*B32^2*B28-20736*B29^3*H21^2*B32*B28^2+10368*B29^4*H21^2*B32*B28^2-5184*B29^4*H21^2*B32^2*B28+864*G20*B31*K16*B29^2-216*G20*B31*K16*B29^3-1440*G20*B31*B9*B29^2+360*G20*B31*B9*B29^3+2832*B31*K16*B9*B29^2-276*B31*K16*B9*B29^3-144*B31*K16*B9*B29^4+5184*B7*G20*B29^2*O15+648*B31*K16*B29^3*H20-216*B31*K16*B29^4*H20-1080*B31*B9*B29^3*H20+360*B31*B9*B29^4*H20+864*B31*K16*B29^2*H21-864*B31*K16*B29^3*H21+216*B31*K16*B29^4*H21-3024*B7*K16*B29^2*O15-1440*B31*B9*B29^2*H21-2592*B7*K16*B29^3*O15+1440*B31*B9*B29^3*H21-360*B31*B9*B29^4*H21+1584*B7*B9*B29^2*O15-864*B7*B9*B29^3*O15+1728*B31*K16*B29^2*P9-432*B31*K16*B29^3*P9-2880*B31*B9*B29^2*P9+720*B31*B9*B29^3*P9-10800*G20*K16*B29^2*B32-1008*G20*B9*B29^2*B32+1116*B31*K16^2*B29*B32-260*B31*B9^2*B29*B32-15552*B7*B29^2*H20*O15+5184*B7*B29^3*H20*O15+3396*K16*B9*B29^2*B32
        V20 = V20.1 + V20.2 + V20.3
        
        #W20
        W20.1 = -432*K16*B9*B29^4*B32+20736*B7*B29^2*H21*O15-5184*B7*B29^3*H21*O15-10368*G20*K16*B29^2*B28+2592*G20*K16*B29^3*B28-3456*G20*B9*B29^2*B28+864*G20*B9*B29^3*B28-4464*B31*K16^2*B29*B28+10368*B7*B29^2*P9*O15+1040*B31*B9^2*B29*B28+5184*G20*B29^2*H20*B32+9216*K16*B9*B29^2*B28+288*K16*B9*B29^3*B28-864*K16*B9*B29^4*B28+10368*G20*B29^2*H21*B32-5184*G20*B29^3*H21*B32-15984*K16*B29^2*H20*B32-2592*K16*B29^3*H20*B32+2592*K16*B29^4*H20*B32-2736*B9*B29^2*H20*B32-864*B9*B29^3*H20*B32+864*B9*B29^4*H20*B32-21600*K16*B29^2*H21*B32+10800*K16*B29^3*H21*B32+5184*G20*B29^2*P9*B32-2016*B9*B29^2*H21*B32+1008*B9*B29^3*H21*B32+20736*G20*B29^2*H20*B28-5184*G20*B29^3*H20*B28-20736*G20*B29^2*H21*B28+5184*G20*B29^3*H21*B28-13392*K16*B29^2*P9*B32+2592*K16*B29^3*P9*B32-1872*B9*B29^2*P9*B32+864*B9*B29^3*P9*B32-43200*K16*B29^2*H20*B28-4752*K16*B29^3*H20*B28+5184*K16*B29^4*H20*B28-4032*B9*B29^2*H20*B28-4176*B9*B29^3*H20*B28+1728*B9*B29^4*H20*B28+32832*K16*B29^2*H21*B28+7344*K16*B29^3*H21*B28-5184*K16*B29^4*H21*B28+576*B9*B29^2*H21*B28+5040*B9*B29^3*H21*B28-1728*B9*B29^4*H21*B28+82944*B7^2*O15*P16*B8+10368*B29^2*H20*H21*B32-5184*B29^3*H20*H21*B32-20736*K16*B29^2*P9*B28+5184*K16*B29^3*P9*B28-6912*B9*B29^2*P9*B28+1728*B9*B29^3*P9*B28+10368*G20^2*B29*B32*B28+15552*B29^2*H20*P9*B32-5184*B29^3*H20*P9*B32+10368*B29^2*H21*P9*B32-5184*B29^3*H21*P9*B32+42408*K16^2*B29*B32*B28+104*B9^2*B29*B32*B28+20736*B29^2*H20*H21*B28-36288*B29^3*H20*H21*B28+10368*B29^4*H20*H21*B28-16416*G20*K16*B29^2*B32^2*B28^2+5184*G20*K16*B29^3*B32^2*B28^2-288*G20*B9*B29^2*B32^2*B28^2+1728*G20*B9*B29^3*B32^2*B28^2-1872*B31*K16^2*B29^2*B32*B28^2+1368*B31*K16^2*B29^2*B32^2*B28-144*B31^2*K16^2*B29^2*B32*B28+3528*B31*K16^2*B29^3*B32*B28^2+2304*B31*K16^2*B29^3*B32^2*B28-216*B31^2*K16^2*B29^3*B32*B28-1296*B31*K16^2*B29^4*B32*B28^2-864*B31*K16^2*B29^4*B32^2*B28+144*B31^2*K16^2*B29^4*B32*B28-400*B31*B9^2*B29^2*B32*B28^2-40*B31*B9^2*B29^2*B32^2*B28-400*B31^2*B9^2*B29^2*B32*B28-1240*B31*B9^2*B29^3*B32*B28^2+160*B31*B9^2*B29^3*B32^2*B28-600*B31^2*B9^2*B29^3*B32*B28+720*B31*B9^2*B29^4*B32*B28^2+480*B31*B9^2*B29^4*B32^2*B28+400*B31^2*B9^2*B29^4*B32*B28+456*K16*B9*B29^2*B32^2*B28^2-2880*K16*B9*B29^3*B32^2*B28^2+864*K16*B9*B29^4*B32^2*B28^2+10368*G20*B29^2*H20*B32^2*B28^2-10368*G20*B29^3*H20*B32^2*B28^2-10368*G20*B29^3*H21*B32^2*B28^2-16416*K16*B29^2*H20*B32^2*B28^2+21600*K16*B29^3*H20*B32^2*B28^2-5184*K16*B29^4*H20*B32^2*B28^2-288*B9*B29^2*H20*B32^2*B28^2+2016*B9*B29^3*H20*B32^2*B28^2-1728*B9*B29^4*H20*B32^2*B28^2+16416*K16*B29^3*H21*B32^2*B28^2-5184*K16*B29^4*H21*B32^2*B28^2+288*B9*B29^3*H21*B32^2*B28^2-1728*B9*B29^4*H21*B32^2*B28^2-10368*B29^3*H20*H21*B32^2*B28^2+10368*B29^4*H20*H21*B32^2*B28^2+1728*B7*B31*K16*B29^2*O15-432*B7*B31*K16*B29^3*O15-2880*B7*B31*B9*B29^2*O15+720*B7*B31*B9*B29^3*O15-216*G20*B31*K16*B29^2*B32+216*G20*B31*K16*B29^3*B32+360*G20*B31*B9*B29^2*B32-360*G20*B31*B9*B29^3*B32-1716*B31*K16*B9*B29^2*B32+420*B31*K16*B9*B29^3*B32+432*B31*K16*B9*B29^4*B32-1728*G20*B31*K16*B29^2*B28+432*G20*B31*K16*B29^3*B28+2880*G20*B31*B9*B29^2*B28-720*G20*B31*B9*B29^3*B28-4512*B31*K16*B9*B29^2*B28-600*B31*K16*B9*B29^3*B28+576*B31*K16*B9*B29^4*B28+5184*B7*G20*B29^2*O15*B32-648*B31*K16*B29^2*H20*B32-864*B31*K16*B29^3*H20*B32+648*B31*K16*B29^4*H20*B32+1080*B31*B9*B29^2*H20*B32+1440*B31*B9*B29^3*H20*B32-1080*B31*B9*B29^4*H20*B32+432*B31*K16*B29^2*H21*B32+216*B31*K16*B29^3*H21*B32-216*B31*K16*B29^4*H21*B32+10368*B7*G20*B29^2*P16*B8-13392*B7*K16*B29^2*O15*B32-720*B31*B9*B29^2*H21*B32+2592*B7*K16*B29^3*O15*B32-360*B31*B9*B29^3*H21*B32+360*B31*B9*B29^4*H21*B32-1872*B7*B9*B29^2*O15*B32
        W20.2 = 864*B7*B9*B29^3*O15*B32+43200*B7*K16*B29^2*P16*B8-10368*B7*K16*B29^3*P16*B8-1296*B31*K16*B29^2*P9*B32+864*B31*K16*B29^3*P9*B32+19584*B7*B9*B29^2*P16*B8-3456*B7*B9*B29^3*P16*B8+2160*B31*B9*B29^2*P9*B32-1440*B31*B9*B29^3*P9*B32+1728*B31*K16*B29^2*H20*B28-3024*B31*K16*B29^3*H20*B28+864*B31*K16*B29^4*H20*B28-2880*B31*B9*B29^2*H20*B28+5040*B31*B9*B29^3*H20*B28-1440*B31*B9*B29^4*H20*B28-3456*B31*K16*B29^2*H21*B28+3456*B31*K16*B29^3*H21*B28-864*B31*K16*B29^4*H21*B28-20736*B7*K16*B29^2*O15*B28+5760*B31*B9*B29^2*H21*B28+5184*B7*K16*B29^3*O15*B28-5760*B31*B9*B29^3*H21*B28+1440*B31*B9*B29^4*H21*B28-6912*B7*B9*B29^2*O15*B28+1728*B7*B9*B29^3*O15*B28-3456*B31*K16*B29^2*P9*B28+864*B31*K16*B29^3*P9*B28+15552*B7*B29^2*H20*O15*B32-5184*B7*B29^3*H20*O15*B32+5760*B31*B9*B29^2*P9*B28-1440*B31*B9*B29^3*P9*B28+10368*B7*B29^2*H21*O15*B32-5184*B7*B29^3*H21*O15*B32-31104*B7*B29^2*H20*P16*B8+10368*B7*B29^3*H20*P16*B8+16416*G20*K16*B29^2*B32*B28+2592*G20*K16*B29^3*B32*B28+41472*B7*B29^2*H21*P16*B8+288*G20*B9*B29^2*B32*B28-10368*B7*B29^3*H21*P16*B8+864*G20*B9*B29^3*B32*B28-2232*B31*K16^2*B29*B32*B28+520*B31*B9^2*B29*B32*B28+41472*B7*B29^2*H20*O15*B28-10368*B7*B29^3*H20*O15*B28-3912*K16*B9*B29^2*B32*B28-3168*K16*B9*B29^3*B32*B28+1728*K16*B9*B29^4*B32*B28-41472*B7*B29^2*H21*O15*B28+20736*B7*B29^2*P9*P16*B8+10368*B7*B29^3*H21*O15*B28-82944*B7^2*B29*O15*P16*B8-5184*G20*B29^3*H20*B32*B28-31104*G20*B29^2*H21*B32*B28+15552*G20*B29^3*H21*B32*B28+10368*K16*B29^2*H20*B32*B28+26352*K16*B29^3*H20*B32*B28-10368*K16*B29^4*H20*B32*B28+3456*B9*B29^2*H20*B32*B28+6192*B9*B29^3*H20*B32*B28-3456*B9*B29^4*H20*B32*B28+59616*K16*B29^2*H21*B32*B28-29808*K16*B29^3*H21*B32*B28-10368*G20*B29^2*P9*B32*B28+4320*B9*B29^2*H21*B32*B28-2160*B9*B29^3*H21*B32*B28+26784*K16*B29^2*P9*B32*B28-5184*K16*B29^3*P9*B32*B28+3744*B9*B29^2*P9*B32*B28-1728*B9*B29^3*P9*B32*B28-31104*B29^2*H20*H21*B32*B28+15552*B29^3*H20*H21*B32*B28-31104*B29^2*H20*P9*B32*B28+10368*B29^3*H20*P9*B32*B28-20736*B29^2*H21*P9*B32*B28+10368*B29^3*H21*P9*B32*B28-1368*B31*K16^2*B29^2*B32^2*B28^2+144*B31^2*K16^2*B29^2*B32*B28^2-36*B31^2*K16^2*B29^2*B32^2*B28-2304*B31*K16^2*B29^3*B32^2*B28^2+216*B31^2*K16^2*B29^3*B32*B28^2-144*B31^2*K16^2*B29^3*B32^2*B28+864*B31*K16^2*B29^4*B32^2*B28^2-144*B31^2*K16^2*B29^4*B32*B28^2-144*B31^2*K16^2*B29^4*B32^2*B28+40*B31*B9^2*B29^2*B32^2*B28^2+400*B31^2*B9^2*B29^2*B32*B28^2-100*B31^2*B9^2*B29^2*B32^2*B28-160*B31*B9^2*B29^3*B32^2*B28^2+600*B31^2*B9^2*B29^3*B32*B28^2-400*B31^2*B9^2*B29^3*B32^2*B28-480*B31*B9^2*B29^4*B32^2*B28^2-400*B31^2*B9^2*B29^4*B32*B28^2-400*B31^2*B9^2*B29^4*B32^2*B28+216*G20*B31*K16*B29^2*B32^2+432*G20*B31*K16*B29^3*B32^2-360*G20*B31*B9*B29^2*B32^2-720*G20*B31*B9*B29^3*B32^2+564*B31*K16*B9*B29^2*B32^2-120*B31^2*K16*B9*B29^2*B32+984*B31*K16*B9*B29^3*B32^2-180*B31^2*K16*B9*B29^3*B32-288*B31*K16*B9*B29^4*B32^2+120*B31^2*K16*B9*B29^4*B32-2304*B31*K16*B9*B29^2*B28^2+480*B31^2*K16*B9*B29^2*B28
        W20.3 = 2304*B31*K16*B9*B29^3*B28^2-480*B31^2*K16*B9*B29^3*B28-576*B31*K16*B9*B29^4*B28^2+120*B31^2*K16*B9*B29^4*B28+216*B31*K16*B29^2*H20*B32^2+216*B31*K16*B29^3*H20*B32^2-432*B31*K16*B29^4*H20*B32^2-360*B31*B9*B29^2*H20*B32^2-360*B31*B9*B29^3*H20*B32^2+720*B31*B9*B29^4*H20*B32^2-216*B31*K16*B29^3*H21*B32^2-432*B31*K16*B29^4*H21*B32^2+360*B31*B9*B29^3*H21*B32^2+720*B31*B9*B29^4*H21*B32^2-3456*B31*K16*B29^2*H20*B28^2+3456*B31*K16*B29^3*H20*B28^2-864*B31*K16*B29^4*H20*B28^2+5760*B31*B9*B29^2*H20*B28^2-5760*B31*B9*B29^3*H20*B28^2+1440*B31*B9*B29^4*H20*B28^2+3456*B31*K16*B29^2*H21*B28^2-3456*B31*K16*B29^3*H21*B28^2+864*B31*K16*B29^4*H21*B28^2-5760*B31*B9*B29^2*H21*B28^2+5760*B31*B9*B29^3*H21*B28^2-1440*B31*B9*B29^4*H21*B28^2+10368*G20*K16*B29^2*B32*B28^2+16416*G20*K16*B29^2*B32^2*B28-5184*G20*K16*B29^3*B32*B28^2-5184*G20*K16*B29^3*B32^2*B28+3456*G20*B9*B29^2*B32*B28^2+288*G20*B9*B29^2*B32^2*B28-1728*G20*B9*B29^3*B32*B28^2-1728*G20*B9*B29^3*B32^2*B28-1476*B31*K16^2*B29^2*B32*B28-1296*B31*K16^2*B29^3*B32*B28+1296*B31*K16^2*B29^4*B32*B28+1180*B31*B9^2*B29^2*B32*B28+720*B31*B9^2*B29^3*B32*B28-720*B31*B9^2*B29^4*B32*B28-5760*K16*B9*B29^2*B32*B28^2-456*K16*B9*B29^2*B32^2*B28+6336*K16*B9*B29^3*B32*B28^2+2880*K16*B9*B29^3*B32^2*B28-1728*K16*B9*B29^4*B32*B28^2-864*K16*B9*B29^4*B32^2*B28+20736*B7^2*B29^2*O15*P16*B8-20736*G20*B29^2*H20*B32*B28^2-10368*G20*B29^2*H20*B32^2*B28+10368*G20*B29^3*H20*B32*B28^2+10368*G20*B29^3*H20*B32^2*B28+20736*G20*B29^2*H21*B32*B28^2-10368*G20*B29^3*H21*B32*B28^2+10368*G20*B29^3*H21*B32^2*B28+43200*K16*B29^2*H20*B32*B28^2+16416*K16*B29^2*H20*B32^2*B28-42336*K16*B29^3*H20*B32*B28^2
        W20 = W20.1 + W20.2 + W20.3
        
        #X20
        X20.1 = -21600*K16*B29^3*H20*B32^2*B28+10368*K16*B29^4*H20*B32*B28^2+5184*K16*B29^4*H20*B32^2*B28+4032*B9*B29^2*H20*B32*B28^2+288*B9*B29^2*H20*B32^2*B28-8928*B9*B29^3*H20*B32*B28^2-2016*B9*B29^3*H20*B32^2*B28+3456*B9*B29^4*H20*B32*B28^2+1728*B9*B29^4*H20*B32^2*B28-32832*K16*B29^2*H21*B32*B28^2+16416*K16*B29^3*H21*B32*B28^2-16416*K16*B29^3*H21*B32^2*B28+5184*K16*B29^4*H21*B32^2*B28-576*B9*B29^2*H21*B32*B28^2+288*B9*B29^3*H21*B32*B28^2-288*B9*B29^3*H21*B32^2*B28+1728*B9*B29^4*H21*B32^2*B28+20736*B29^2*H20*H21*B32*B28^2-10368*B29^3*H20*H21*B32*B28^2+10368*B29^3*H20*H21*B32^2*B28-10368*B29^4*H20*H21*B32^2*B28+36*B31^2*K16^2*B29^2*B32^2*B28^2+144*B31^2*K16^2*B29^3*B32^2*B28^2+144*B31^2*K16^2*B29^4*B32^2*B28^2+100*B31^2*B9^2*B29^2*B32^2*B28^2+400*B31^2*B9^2*B29^3*B32^2*B28^2+400*B31^2*B9^2*B29^4*B32^2*B28^2-1728*B7*B31*K16*B29*O15+2880*B7*B31*B9*B29*O15-432*G20*B31*K16*B29*B32+720*G20*B31*B9*B29*B32-1704*B31*K16*B9*B29*B32+1728*G20*B31*K16*B29*B28-2880*G20*B31*B9*B29*B28+6816*B31*K16*B9*B29*B28-10368*B7*G20*B29*O15*B32-432*B31*K16*B29*H20*B32+720*B31*B9*B29*H20*B32-41472*B7*G20*B29*P16*B8+16416*B7*K16*B29*O15*B32+288*B7*B9*B29*O15*B32-48384*B7*K16*B29*P16*B8-864*B31*K16*B29*P9*B32-36864*B7*B9*B29*P16*B8+1440*B31*B9*B29*P9*B32+1728*B31*K16*B29*H20*B28-2880*B31*B9*B29*H20*B28+20736*B7*K16*B29*O15*B28+6912*B7*B9*B29*O15*B28+3456*B31*K16*B29*P9*B28-10368*B7*B29*H20*O15*B32-5760*B31*B9*B29*P9*B28-43200*G20*K16*B29*B32*B28-41472*B7*B29*H21*P16*B8-4032*G20*B9*B29*B32*B28-41472*B7*B29*H20*O15*B28+6672*K16*B9*B29*B32*B28+41472*B7*B29*H21*O15*B28-82944*B7*B29*P9*P16*B8+20736*G20*B29*H20*B32*B28-43200*K16*B29*H20*B32*B28-4032*B9*B29*H20*B32*B28+20736*G20*B29*P9*B32*B28-30*B31^2*K16*B9*B29^2*B32^2-120*B31^2*K16*B9*B29^3*B32^2-120*B31^2*K16*B9*B29^4*B32^2-32832*K16*B29*P9*B32*B28-576*B9*B29*P9*B32*B28-480*B31^2*K16*B9*B29^2*B28^2+480*B31^2*K16*B9*B29^3*B28^2-120*B31^2*K16*B9*B29^4*B28^2+20736*B29*H20*P9*B32*B28-864*B7*B31*K16*B29*O15*B32+1440*B7*B31*B9*B29*O15*B32+6912*B7*B31*K16*B29*P16*B8+9216*B7*B31*B9*B29*P16*B8+3456*B7*B31*K16*B29*O15*B28-5760*B7*B31*B9*B29*O15*B28+864*G20*B31*K16*B29*B32*B28-1440*G20*B31*B9*B29*B32*B28+3408*B31*K16*B9*B29*B32*B28-20736*B7*G20*B29*P16*B32*B8+38016*B7*K16*B29*P16*B32*B8+20736*B7*G20*B29*O15*B32*B28+2304*B7*B9*B29*P16*B32*B8+864*B31*K16*B29*H20*B32*B28-1440*B31*B9*B29*H20*B32*B28-32832*B7*K16*B29*O15*B32*B28-576*B7*B9*B29*O15*B32*B28+82944*B7*K16*B29*P16*B8*B28+1728*B31*K16*B29*P9*B32*B28+27648*B7*B9*B29*P16*B8*B28-2880*B31*B9*B29*P9*B32*B28-20736*B7*B29*H20*P16*B32*B8+20736*B7*B29*H20*O15*B32*B28-82944*B7*B29*H20*P16*B8*B28+82944*B7*B29*H21*P16*B8*B28+864*G20*B31*K16*B29^2*B32^2*B28^2+1728*G20*B31*K16*B29^3*B32^2*B28^2-1440*G20*B31*B9*B29^2*B32^2*B28^2-2880*G20*B31*B9*B29^3*B32^2*B28^2+2256*B31*K16*B9*B29^2*B32^2*B28^2-480*B31^2*K16*B9*B29^2*B32*B28^2+120*B31^2*K16*B9*B29^2*B32^2*B28+3936*B31*K16*B9*B29^3*B32^2*B28^2-720*B31^2*K16*B9*B29^3*B32*B28^2+480*B31^2*K16*B9*B29^3*B32^2*B28-1152*B31*K16*B9*B29^4*B32^2*B28^2+480*B31^2*K16*B9*B29^4*B32*B28^2+480*B31^2*K16*B9*B29^4*B32^2*B28+864*B31*K16*B29^2*H20*B32^2*B28^2+864*B31*K16*B29^3*H20*B32^2*B28^2-1728*B31*K16*B29^4*H20*B32^2*B28^2-1440*B31*B9*B29^2*H20*B32^2*B28^2-1440*B31*B9*B29^3*H20*B32^2*B28^2+2880*B31*B9*B29^4*H20*B32^2*B28^2-864*B31*K16*B29^3*H21*B32^2*B28^2-1728*B31*K16*B29^4*H21*B32^2*B28^2+1440*B31*B9*B29^3*H21*B32^2*B28^2+2880*B31*B9*B29^4*H21*B32^2*B28^2-1296*B7*B31*K16*B29^2*O15*B32+864*B7*B31*K16*B29^3*O15*B32+2160*B7*B31*B9*B29^2*O15*B32-1440*B7*B31*B9*B29^3*O15*B32-6912*B7*B31*K16*B29^2*P16*B8
        X20.2 = 1728*B7*B31*K16*B29^3*P16*B8-9216*B7*B31*B9*B29^2*P16*B8+2304*B7*B31*B9*B29^3*P16*B8-3456*B7*B31*K16*B29^2*O15*B28+864*B7*B31*K16*B29^3*O15*B28+5760*B7*B31*B9*B29^2*O15*B28-1440*B7*B31*B9*B29^3*O15*B28-432*G20*B31*K16*B29^2*B32*B28+720*G20*B31*B9*B29^2*B32*B28+1752*B31*K16*B9*B29^2*B32*B28+1728*B31*K16*B9*B29^3*B32*B28-1728*B31*K16*B9*B29^4*B32*B28+10368*B7*G20*B29^2*P16*B32*B8-39744*B7*K16*B29^2*P16*B32*B8+10368*B7*K16*B29^3*P16*B32*B8-10368*B7*G20*B29^2*O15*B32*B28-8064*B7*B9*B29^2*P16*B32*B8+3456*B7*B9*B29^3*P16*B32*B8+1296*B31*K16*B29^2*H20*B32*B28+4320*B31*K16*B29^3*H20*B32*B28-2592*B31*K16*B29^4*H20*B32*B28-2160*B31*B9*B29^2*H20*B32*B28-7200*B31*B9*B29^3*H20*B32*B28+4320*B31*B9*B29^4*H20*B32*B28-1728*B31*K16*B29^2*H21*B32*B28-864*B31*K16*B29^3*H21*B32*B28+864*B31*K16*B29^4*H21*B32*B28+26784*B7*K16*B29^2*O15*B32*B28+2880*B31*B9*B29^2*H21*B32*B28-5184*B7*K16*B29^3*O15*B32*B28+1440*B31*B9*B29^3*H21*B32*B28-1440*B31*B9*B29^4*H21*B32*B28+3744*B7*B9*B29^2*O15*B32*B28-1728*B7*B9*B29^3*O15*B32*B28-82944*B7*K16*B29^2*P16*B8*B28+20736*B7*K16*B29^3*P16*B8*B28+2592*B31*K16*B29^2*P9*B32*B28-1728*B31*K16*B29^3*P9*B32*B28-27648*B7*B9*B29^2*P16*B8*B28+6912*B7*B9*B29^3*P16*B8*B28-4320*B31*B9*B29^2*P9*B32*B28+2880*B31*B9*B29^3*P9*B32*B28+31104*B7*B29^2*H20*P16*B32*B8-10368*B7*B29^3*H20*P16*B32*B8+20736*B7*B29^2*H21*P16*B32*B8-10368*B7*B29^3*H21*P16*B32*B8-31104*B7*B29^2*H20*O15*B32*B28+10368*B7*B29^3*H20*O15*B32*B28-20736*B7*B29^2*H21*O15*B32*B28+10368*B7*B29^3*H21*O15*B32*B28+82944*B7*B29^2*H20*P16*B8*B28-20736*B7*B29^3*H20*P16*B8*B28-82944*B7*B29^2*H21*P16*B8*B28+20736*B7*B29^3*H21*P16*B8*B28-120*B31^2*K16*B9*B29^2*B32^2*B28^2-480*B31^2*K16*B9*B29^3*B32^2*B28^2-480*B31^2*K16*B9*B29^4*B32^2*B28^2+1728*G20*B31*K16*B29^2*B32*B28^2-864*G20*B31*K16*B29^2*B32^2*B28-864*G20*B31*K16*B29^3*B32*B28^2-1728*G20*B31*K16*B29^3*B32^2*B28-2880*G20*B31*B9*B29^2*B32*B28^2+1440*G20*B31*B9*B29^2*B32^2*B28+1440*G20*B31*B9*B29^3*B32*B28^2+2880*G20*B31*B9*B29^3*B32^2*B28+3360*B31*K16*B9*B29^2*B32*B28^2-2256*B31*K16*B9*B29^2*B32^2*B28+480*B31^2*K16*B9*B29^2*B32*B28-5136*B31*K16*B9*B29^3*B32*B28^2-3936*B31*K16*B9*B29^3*B32^2*B28
        X20.3 = 720*B31^2*K16*B9*B29^3*B32*B28+1728*B31*K16*B9*B29^4*B32*B28^2+1152*B31*K16*B9*B29^4*B32^2*B28-480*B31^2*K16*B9*B29^4*B32*B28-864*B31*K16*B29^2*H20*B32^2*B28-5184*B31*K16*B29^3*H20*B32*B28^2-864*B31*K16*B29^3*H20*B32^2*B28+2592*B31*K16*B29^4*H20*B32*B28^2+1728*B31*K16*B29^4*H20*B32^2*B28+1440*B31*B9*B29^2*H20*B32^2*B28+8640*B31*B9*B29^3*H20*B32*B28^2+1440*B31*B9*B29^3*H20*B32^2*B28-4320*B31*B9*B29^4*H20*B32*B28^2-2880*B31*B9*B29^4*H20*B32^2*B28+1728*B31*K16*B29^2*H21*B32*B28^2+864*B31*K16*B29^3*H21*B32*B28^2+864*B31*K16*B29^3*H21*B32^2*B28-864*B31*K16*B29^4*H21*B32*B28^2+1728*B31*K16*B29^4*H21*B32^2*B28-2880*B31*B9*B29^2*H21*B32*B28^2-1440*B31*B9*B29^3*H21*B32*B28^2-1440*B31*B9*B29^3*H21*B32^2*B28+1440*B31*B9*B29^4*H21*B32*B28^2-2880*B31*B9*B29^4*H21*B32^2*B28+3456*B7*B31*K16*B29*P16*B32*B8+4608*B7*B31*B9*B29*P16*B32*B8+1728*B7*B31*K16*B29*O15*B32*B28-2880*B7*B31*B9*B29*O15*B32*B28-13824*B7*B31*K16*B29*P16*B8*B28-18432*B7*B31*B9*B29*P16*B8*B28+41472*B7*G20*B29*P16*B32*B8*B28-76032*B7*K16*B29*P16*B32*B8*B28-4608*B7*B9*B29*P16*B32*B8*B28+41472*B7*B29*H20*P16*B32*B8*B28+5184*B7*B31*K16*B29^2*P16*B32*B8-3456*B7*B31*K16*B29^3*P16*B32*B8+6912*B7*B31*B9*B29^2*P16*B32*B8-4608*B7*B31*B9*B29^3*P16*B32*B8+2592*B7*B31*K16*B29^2*O15*B32*B28-1728*B7*B31*K16*B29^3*O15*B32*B28-4320*B7*B31*B9*B29^2*O15*B32*B28+2880*B7*B31*B9*B29^3*O15*B32*B28+13824*B7*B31*K16*B29^2*P16*B8*B28-3456*B7*B31*K16*B29^3*P16*B8*B28+18432*B7*B31*B9*B29^2*P16*B8*B28-4608*B7*B31*B9*B29^3*P16*B8*B28-20736*B7*G20*B29^2*P16*B32*B8*B28+79488*B7*K16*B29^2*P16*B32*B8*B28-20736*B7*K16*B29^3*P16*B32*B8*B28+16128*B7*B9*B29^2*P16*B32*B8*B28-6912*B7*B9*B29^3*P16*B32*B8*B28-62208*B7*B29^2*H20*P16*B32*B8*B28+20736*B7*B29^3*H20*P16*B32*B8*B28-41472*B7*B29^2*H21*P16*B32*B8*B28+20736*B7*B29^3*H21*P16*B32*B8*B28-10368*B7*B31*K16*B29^2*P16*B32*B8*B28+6912*B7*B31*K16*B29^3*P16*B32*B8*B28-13824*B7*B31*B9*B29^2*P16*B32*B8*B28+9216*B7*B31*B9*B29^3*P16*B32*B8*B28-6912*B7*B31*K16*B29*P16*B32*B8*B28-9216*B7*B31*B9*B29*P16*B32*B8*B28
        X20 = X20.1 + X20.2 +X20.3
        
        #Y20
        Y20 = (V20+W20+X20)^(1/2)
        
        #V21 Pre-Calculations
        
        P15 = (72*G20-186*K16-26*B9+72*H20+144*P9+18*K16*B29^2+6*B9*B29^2-36*B29^2*H20+36*B29^2*H21+Y20-36*G20*B29+57*K16*B29+B9*B29+144*B7*O15+36*B29*H20-72*B29*H21-72*B29*P9-6*B31*K16*B29+10*B31*B9*B29-72*B7*B29*O15-36*G20*B29*B32+57*K16*B29*B32+B9*B29*B32-288*B7*P16*B8+72*K16*B29*B28+24*B9*B29*B28-36*B29*H20*B32-144*B29*H20*B28+144*B29*H21*B28+3*B31*K16*B29^2-5*B31*B9*B29^2-18*K16*B29^2*B32-6*B9*B29^2*B32-36*K16*B29^2*B28-12*B9*B29^2*B28+36*B29^2*H20*B32+36*B29^2*H21*B32+72*B29^2*H20*B28-72*B29^2*H21*B28-72*B29^2*H20*B32*B28-72*B29^2*H21*B32*B28-3*B31*K16*B29*B32+5*B31*B9*B29*B32+12*B31*K16*B29*B28-20*B31*B9*B29*B28+144*B7*B29*P16*B8+72*G20*B29*B32*B28-114*K16*B29*B32*B28-2*B9*B29*B32*B28+72*B29*H20*B32*B28-6*B31*K16*B29^2*B32+10*B31*B9*B29^2*B32-6*B31*K16*B29^2*B28+10*B31*B9*B29^2*B28+36*K16*B29^2*B32*B28+12*B9*B29^2*B32*B28+12*B31*K16*B29^2*B32*B28-20*B31*B9*B29^2*B32*B28+6*B31*K16*B29*B32*B28-10*B31*B9*B29*B32*B28)/(144*(2*B7-B7*B29))
        K7 = (K16+1/3*B9)/(2+4*B8*P16/P15)
        K8 = K8 = K7*2*B8*P16/P15
        K10 = 2*K7+3/2*K8-B9/3
        K12 = K7+K8
        K11 = 5/3*K12
        K9 = K10-K11
        O24 = B32/(1-0.5*B29)*((1-B29)/2*(H20-H21+1/2*K8-K7-2*K8-1/2*B31*K9)+(0.5*G20-0.25*(1-B31)*(1/3*K7*(1-B8*P16/P15)-1/3*B9)-K7*(1+2*B8*P16/P15)+1/6*B9+0.5*(H21)))
        
        #V21
        V21 = (0.5*G20-0.25*(1-B31)*(1/3*K7*(1-B8*P16/P15)-1/3*B9)-K7*(1+2*B8*P16/P15)+1/6*B9+0.5*(H21+O24))+(1-B29)/2*(H20-H21-O24+1/2*K8-K7-2*K8-1/2*B31*K9)+(1-B28)*B29*(H20-H21-O24+1/2*K8-K7-2*K8-1/2*B31*K9)
        
        #W21
        W21 = -P15+O15+((0.5*G20-0.25*(1-B31)*(1/3*K7*(1-B8*P16/P15)-1/3*B9)-K7*(1+2*B8*P16/P15)+1/6*B9+0.5*(H21+B32/(1-0.5*B29)*((1-B29)/2*H20-B29/2*H21+1/2*G20-K9*(1/4-1/4*B31-1/2*B29*B31)+1/6*B9-K7*(1+2*B8*P16/P15*(1+3/4*(1-B29))+(1-B29)/2))))+(1-B29)/2*(H20-H21-B32/(1-0.5*B29)*((1-B29)/2*H20-B29/2*H21+1/2*G20-K9*(1/4-1/4*B31-1/2*B29*B31)+1/6*B9-K7*(1+2*B8*P16/P15*(1+3/4*(1-B29))+(1-B29)/2))+1/2*K8-K7-2*K8-1/2*B31*K9)+(1-B28)*B29*(H20-H21-B32/(1-0.5*B29)*((1-B29)/2*H20-B29/2*H21+1/2*G20-K9*(1/4-1/4*B31-1/2*B29*B31)+1/6*B9-K7*(1+2*B8*P16/P15*(1+3/4*(1-B29))+(1-B29)/2))+1/2*K8-K7-2*K8-1/2*B31*K9)+P9-(K16+1/3*B9)/(2+4*B8*P16/P15)+(K16+1/3*B9)/(2+4*B8*P16/P15)*B8*P16/P15)/B7
        
        #X21
        X21 = -P15+O15+((0.5*G20-0.25*(1-B31)*(1/3* (K16+1/3*B9)/(2+4*B8*P16/P15)*(1-B8*P16/P15)-1/3*B9)- (K16+1/3*B9)/(2+4*B8*P16/P15)*(1+2*B8*P16/P15)+1/6*B9+0.5*(H21+B32/(1-0.5*B29)*((1-B29)/2*H20-B29/2*H21+1/2*G20-K9*(1/4-1/4*B31-1/2*B29*B31)+1/6*B9-(K16+1/3*B9)/(2+4*B8*P16/P15)*(1+2*B8*P16/P15*(1+3/4*(1-B29))+(1-B29)/2))))+(1-B29)/2*(H20-H21-B32/(1-0.5*B29)*((1-B29)/2*H20-B29/2*H21+1/2*G20-K9*(1/4-1/4*B31-1/2*B29*B31)+1/6*B9- (K16+1/3*B9)/(2+4*B8*P16/P15)*(1+2*B8*P16/P15*(1+3/4*(1-B29))+(1-B29)/2))+1/2*(K16+1/3*B9)/(2+4*B8*P16/P15)*2*B8*P16/P15- (K16+1/3*B9)/(2+4*B8*P16/P15)-2*(K16+1/3*B9)/(2+4*B8*P16/P15)*2*B8*P16/P15-1/2*B31*K9)+(1-B28)*B29*(H20-H21-B32/(1-0.5*B29)*((1-B29)/2*H20-B29/2*H21+1/2*G20-K9*(1/4-1/4*B31-1/2*B29*B31)+1/6*B9-(K16+1/3*B9)/(2+4*B8*P16/P15)*(1+2*B8*P16/P15*(1+3/4*(1-B29))+(1-B29)/2))+1/2*(K16+1/3*B9)/(2+4*B8*P16/P15)*2*B8*P16/P15- (K16+1/3*B9)/(2+4*B8*P16/P15)-2*(K16+1/3*B9)/(2+4*B8*P16/P15)*2*B8*P16/P15-1/2*B31*K9)+P9-(K16+1/3*B9)/(2+4*B8*P16/P15)+(K16+1/3*B9)/(2+4*B8*P16/P15)*B8*P16/P15)/B7
        
        #Y21
        Y21 = -P15+O15+((0.5*G20-0.25*(1-B31)*(1/3* (K16+1/3*B9)/(2+4*B8*P16/P15)*(1-B8*P16/P15)-1/3*B9)- (K16+1/3*B9)/(2+4*B8*P16/P15)*(1+2*B8*P16/P15)+1/6*B9+0.5*(H21+B32/(1-0.5*B29)*((1-B29)/2*H20-B29/2*H21+1/2*G20-(1/3*(K16+1/3*B9)/(2+4*B8*P16/P15)-1/6*(K16+1/3*B9)/(2+4*B8*P16/P15)*2*B8*P16/P15-1/3*B9)*(1/4-1/4*B31-1/2*B29*B31)+1/6*B9- (K16+1/3*B9)/(2+4*B8*P16/P15)*(1+2*B8*P16/P15*(1+3/4*(1-B29))+(1-B29)/2))))+(1-B29)/2*(H20-H21-B32/(1-0.5*B29)*((1-B29)/2*H20-B29/2*H21+1/2*G20-(1/3*(K16+1/3*B9)/(2+4*B8*P16/P15)-1/6*(K16+1/3*B9)/(2+4*B8*P16/P15)*2*B8*P16/P15-1/3*B9)*(1/4-1/4*B31-1/2*B29*B31)+1/6*B9-(K16+1/3*B9)/(2+4*B8*P16/P15)*(1+2*B8*P16/P15*(1+3/4*(1-B29))+(1-B29)/2))+1/2*(K16+1/3*B9)/(2+4*B8*P16/P15)*2*B8*P16/P15-(K16+1/3*B9)/(2+4*B8*P16/P15)-2*(K16+1/3*B9)/(2+4*B8*P16/P15)*2*B8*P16/P15-1/2*B31*(1/3*(K16+1/3*B9)/(2+4*B8*P16/P15)-1/6*(K16+1/3*B9)/(2+4*B8*P16/P15)*2*B8*P16/P15-1/3*B9))+(1-B28)*B29*(H20-H21-B32/(1-0.5*B29)*((1-B29)/2*H20-B29/2*H21+1/2*G20-(1/3*(K16+1/3*B9)/(2+4*B8*P16/P15)-1/6*(K16+1/3*B9)/(2+4*B8*P16/P15)*2*B8*P16/P15-1/3*B9)*(1/4-1/4*B31-1/2*B29*B31)+1/6*B9- (K16+1/3*B9)/(2+4*B8*P16/P15)*(1+2*B8*P16/P15*(1+3/4*(1-B29))+(1-B29)/2))+1/2*(K16+1/3*B9)/(2+4*B8*P16/P15)*2*B8*P16/P15- (K16+1/3*B9)/(2+4*B8*P16/P15)-2*(K16+1/3*B9)/(2+4*B8*P16/P15)*2*B8*P16/P15-1/2*B31*(1/3*(K16+1/3*B9)/(2+4*B8*P16/P15)-1/6*(K16+1/3*B9)/(2+4*B8*P16/P15)*2*B8*P16/P15-1/3*B9))+P9-(K16+1/3*B9)/(2+4*B8*P16/P15)+(K16+1/3*B9)/(2+4*B8*P16/P15)*B8*P16/P15)/B7
        
        #V22
        V22 = (72*G20-186*K16-26*B9+72*H20+144*P9+18*K16*B29^2+6*B9*B29^2-36*B29^2*H20+36*B29^2*H21+Y20-36*G20*B29+57*K16*B29+B9*B29+144*B7*O15+36*B29*H20-72*B29*H21-72*B29*P9-6*B31*K16*B29+10*B31*B9*B29-72*B7*B29*O15-36*G20*B29*B32+57*K16*B29*B32+B9*B29*B32-288*B7*P16*B8+72*K16*B29*B28+24*B9*B29*B28-36*B29*H20*B32-144*B29*H20*B28+144*B29*H21*B28+3*B31*K16*B29^2-5*B31*B9*B29^2-18*K16*B29^2*B32-6*B9*B29^2*B32-36*K16*B29^2*B28-12*B9*B29^2*B28+36*B29^2*H20*B32+36*B29^2*H21*B32+72*B29^2*H20*B28-72*B29^2*H21*B28-72*B29^2*H20*B32*B28-72*B29^2*H21*B32*B28-3*B31*K16*B29*B32+5*B31*B9*B29*B32+12*B31*K16*B29*B28-20*B31*B9*B29*B28+144*B7*B29*P16*B8+72*G20*B29*B32*B28-114*K16*B29*B32*B28-2*B9*B29*B32*B28+72*B29*H20*B32*B28-6*B31*K16*B29^2*B32+10*B31*B9*B29^2*B32-6*B31*K16*B29^2*B28+10*B31*B9*B29^2*B28+36*K16*B29^2*B32*B28+12*B9*B29^2*B32*B28+12*B31*K16*B29^2*B32*B28-20*B31*B9*B29^2*B32*B28+6*B31*K16*B29*B32*B28-10*B31*B9*B29*B32*B28)/(144*(2*B7-B7*B29))
        
        #Overall Rates Pre-Calculations
        O24 = B32/(1-0.5*B29)*((1-B29)/2*(H20-H21+1/2*K8-K7-2*K8-1/2*B31*K9)+(0.5*G20-0.25*(1-B31)*(1/3*K7*(1-B8*P16/P15)-1/3*B9)-K7*(1+2*B8*P16/P15)+1/6*B9+0.5*(H21)))
        K27 = B29*(H20-H21-O24+1/2*K8-K7-2*K8-1/2*B31*K9)
        P11 = (1-B29)/2*(H20-H21-O24+1/2*K8-K7-2*K8-1/2*B31*K9)
        O11 = (0.5*G20-0.25*(1-B31)*(1/3*K7*(1-B8*P16/P15)-1/3*B9)-K7*(1+2*B8*P16/P15)+1/6*B9+0.5*(H21+O24))
        
        #Overall Rates
        K5 = K7-0.5*K8-B9
        K6 = K5+B9
        K13 = K8
        K14 = 1/2*K8+K10
        K15 = K10+K7+2*K8+0.5*K9+K27+2*P11+2*O11
        K17 = G20+H20
        
        #Create Overall Rates Data Frame
        OverallRates <- data.frame(Parameter = c("A","GA","Vc","Vo","Carb Synthesis CS tot","PGA Reduction PR TOT","DHAP Entering RPP","RuP Phosphorylation","GDC TOT","NADPH Demand Tot","ATP Demand Tot","J NADPH","J ATP"),
                                   Value = c (K5,K6,K7,K8,K9,K10,K11,K12,K13,K14,K15,K16,K17),
                                   stringsAsFactors = FALSE)

        #CCM
        K26 = O11+K27*(1-B28)+P11
        K28 = K27*B28
        
        #Create CCM Data Frame
        CCM <- data.frame(Parameter = c("VP","PEPCK","PH"),
                                    Value = c (K26,K27,K28),
                                   stringsAsFactors = FALSE)
        
        #BS/M Partitioning Pre-Calculations
        P7 = K8
        P10 = K9*B31
        P12 = (H21+O24-0.5*P7)
        O6 = 0
        O7 = 0
        O14 = O6+O7
        P6 = K7
        P14 = P6+P7
        
        
        #BS/M Partitioning
        
        #M Partitioning
        O8 = 0
        O9 = B9-P9
        O10 = K9-P10
        O12 = K10-P12
        O13 =  5/3*O14
        O16 = B6
        
        #BS Partitioning
        P8 = K13
        P13 =  5/3*P14

        #Create BS/M Partitioning Data Frame
        BSMPartitioning <- data.frame(Parameter = c("Vc","Vo","GDC","RLight","Carb Synthesis CS","PPDK","PGA reduction PR","DHAP entering RPP","RuP phosphorylation","C","O"),
                                     M = c (O6,O7,O8,O9,O10,O11,O12,O13,O14,O15,O16),BS = c (P6,P7,P8,P9,P10,P11,P12,P13,P14,P15,P16),
                                     stringsAsFactors = FALSE)
        
        
        
        
        
        
        #Reducing Power Balance
        
        #M
        O22 = G21
        O23 = O12+0.5*O7-0.5*(O8-O7)
        O25 =  K26-O24
        O26 = "-"
        O27 = O24+O23
        O28 = 2*O11++O6+2*O7+O10/2+O12+0.5*(O8-O7)
        
        #BS
        P22 = K26-K27
        P23 = P12-0.5*(P8-P7)+0.5*P7
        P24 = O25-K27
        P25 = O25
        P26 = O24+P24
        P27 = P23-P26+P24
        P28 = P12+P6+2*P7+2*P11+K27+0.5*P10+0.5*(P8-P7)
        
        #Create Reducing Power Balance Data Frame
        ReducingPowerBalance <- data.frame(Parameter = c("NADPH potent. avail.","NADPH demand (excl. CCM)","MDH","Transamination T","ME","NADPH demand","ATP demand"),
                                      M = c (O22,O23,O24,O25,O26,O27,O28),
                                      BS = c (P22,P23,P24,P25,P26,P27,P28),
                                      stringsAsFactors = FALSE)
        
        #Ratios Pre-Calculations
        T19 = (K26+P9+1/2*P8-P6)
        
        #Ratios
        
        T5 = K15/K6
        
        if (typeof(T19/K26)=="double"){
            T6 = T19/K26
        } else
            T6 = "-"
        
        T7 = K15/K14
        T8 = P23/K14
        
        if (typeof(P23/O23)=="double"){
            T9 = P23/O23
        } else
            T9 = "-"
        
        if (typeof(P28/O28)=="double"){
            T10 = P28/O28
        } else
            T10 = "-"
        
        T11 = P28/K15
        
        if (typeof(O28/O27)=="double"){
            T12 = O28/O27
        } else
            T12 = "-"
        
        if (typeof((K27+P24)/O24)=="double"){
            T13 = (K27+P24)/O24
        } else
            T13 = "-"
        
        if (typeof(O25/K26)=="double"){
            T14 = O25/K26
        } else
            T14 = "-"
        
        T15 = (K15+K14)/K6
        
        #Create Ratios Data Frame
        Ratios <- data.frame(Parameter = c("ATP TOT / GA.","Leakiness Phi","ATP TOT / NADPH TOT","NADPH BS / NADPH TOT","NADPH BS / NADPH M","ATP BS / ATP M","ATP BS / ATP TOT","Photo-prod. ATP M / NADPH M","ASP/MAL decarboxilation","T/Vp","(ATP TOT + NADPH TOT)/GA"),
                                           Value = c (T5,T6,T7,T8,T9,T10,T11,T12,T13,T14,T15),
                                           stringsAsFactors = FALSE)
        
        #Fluxes Pre-Calculations
        X30 = O7-O8
        X31 = 1/2*X30
        
        #Fluxes
        T20 = O12-O10-O13
        T21 = 2*P6+1.5*P7-P12-1/3*P9
        T22 = O24
        T23 = K27*(1-B28)+P11
        T24 = O25
        T25 = T23+T21-T20
        T26 = T24+X31
        T27 = P26-O25-X31-P11+B28*K27
        T28 =abs(T19)+abs(T20)+abs(T21)+abs(T22)+abs(T23)+abs(T24)+abs(X30)+abs(X31)+abs(T26)+abs(T27)+abs(T25)
        
        #Create Fluxes Data Frame
        Fluxes <- data.frame(Parameter = c("CO2 BS->M Leak rate L","DHAP M->BS","PGA BS->M","MAL M->BS","PEP BS->M","ASP M->BS","Pi M->BS","ALA BS->M","PYR BS->M","Total fluxes"),
                             Value = c (T19,T20,T21,T22,T23,T24,T25,T26,T27,T28),
                             stringsAsFactors = FALSE)
        
        
        
        #Add Data Frames To List
        dataframelist = list(LightReactions = LightReactions,OverallRates = OverallRates,CCM=CCM,BSMPartitioning = BSMPartitioning,ReducingPowerBalance=ReducingPowerBalance,Ratios=Ratios,Fluxes=Fluxes)
        dataframelist
        

    }
        
    )

    output$LightReactions <- DT::renderDataTable({datatable(data = updateOutputs()$LightReactions,options=list(dom = 't',pageLength = 17))})
    output$OverallRates <- DT::renderDataTable({datatable(data = updateOutputs()$OverallRates,options=list(dom = 't', pageLength =  13))}) 
    output$CCM <- DT::renderDataTable({datatable(data = updateOutputs()$CCM,options=list(dom = 't',pageLength = 3))})
    output$BSMPartitioning <- DT::renderDataTable({datatable(data = updateOutputs()$BSMPartitioning,options=list(dom = 't',pageLength = 11))})
    output$ReducingPowerBalance <- DT::renderDataTable({datatable(data = updateOutputs()$ReducingPowerBalance,options=list(dom = 't',pageLength = 7))})
    output$Ratios <- DT::renderDataTable({datatable(data = updateOutputs()$Ratios,options=list(dom = 't',pageLength = 11))})
    output$Fluxes <- DT::renderDataTable({datatable(data = updateOutputs()$Fluxes,options=list(dom = 't',pageLength = 10))})
        })
    
    

shinyApp(ui=ui, server = server)